#-*- mode: ruby -*-
require 'fileutils'

gemspec

version = File.read( File.join( File.dirname(File.expand_path(__FILE__)), '..', '..', 'VERSION' ) ).strip

inherit "org.jruby:jruby-artifacts:#{version}"

ruby_version = model.version

model.version = nil

name "JRuby Jars Gem"

jar 'org.jruby:jruby-stdlib', '${project.parent.version}'

plugin( :clean, '2.5' ) do
  execute_goals( :clean,
                 :phase => :clean, 
                 :id => 'clean-lib',
                 :filesets => [ { :directory => '${basedir}/lib',
                                  :includes => ['*.jar'] } ],
                 :failOnError => false )
end

properties( 'tesla.dump.pom' => 'pom.xml',
            'tesla.version' => '0.1.1',
            # we share the already installed gems
            'gem.home' => '${jruby.home}/lib/ruby/gems/shared',
            'jruby.home' => '${basedir}/../../' )

execute 'copy jruby.jar', 'prepare-package' do |ctx|
  FileUtils.cp( File.join( ctx.project.properties[ 'jruby.home' ],
                           'lib',
                           'jruby.jar' ),
                File.join( ctx.project.basedir.to_s, 
                           'lib',
                           "jruby-core-complete-#{ctx.project.version}.jar" ) )
end

# do not push the gem during deploy phase
# the bang reuses the plugin declaration which is already in place and
# adds the extra execute_goal to it
jruby_plugin!( :gem,
               :gemspec => 'jruby-jars.gemspec',
               # tell maven to include the jar files into gem
               :includeDependencies => true ) do
  execute_goals :id => 'default-push', :skip => true
end

plugin :invoker, :properties => { 'ruby.version' => ruby_version, 'gem.home' => '${project.build.directory}', 'gem.path' => '${project.build.directory}' }

execute 'rename gem file', :verify do |ctx|
  require 'fileutils'
  FileUtils.rm_rf(Dir["#{ctx.project.build.directory}/*.gem"])
  FileUtils.mv(Dir["#{ctx.project.basedir}/*.gem"], ctx.project.build.directory)
end

# vim: syntax=Ruby
